{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/LENOVO/tinylink/TinyLink/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\ndeclare global {\r\n  // allow global prisma during dev to avoid multiple instances\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nconst prisma = global.prisma ?? new PrismaClient();\r\nif (process.env.NODE_ENV !== 'production') global.prisma = prisma;\r\n\r\nconst CODE_REGEX = /^[A-Za-z0-9]{6,8}$/;\r\n\r\nfunction genCode(length = 6) {\r\n  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n  let s = '';\r\n  for (let i = 0; i < length; i++) s += chars[Math.floor(Math.random() * chars.length)];\r\n  return s;\r\n}\r\n\r\nfunction ensureValidUrl(url: string) {\r\n  try {\r\n    // allow relative? spec requires full URL â€” validate absolute only\r\n    const u = new URL(url);\r\n    return u.toString();\r\n  } catch {\r\n    throw new Error('INVALID_URL');\r\n  }\r\n}\r\n\r\nexport async function createLink({ url, code }: { url: string; code?: string }) {\r\n  const safeUrl = ensureValidUrl(url);\r\n\r\n  let finalCode = code?.trim();\r\n  if (finalCode) {\r\n    if (!CODE_REGEX.test(finalCode)) throw new Error('INVALID_CODE');\r\n    const existing = await prisma.link.findUnique({ where: { code: finalCode } });\r\n    if (existing) throw new Error('CODE_EXISTS');\r\n  } else {\r\n    // generate until unique (rare collision)\r\n    let attempts = 0;\r\n    do {\r\n      finalCode = genCode(6);\r\n      const exists = await prisma.link.findUnique({ where: { code: finalCode } });\r\n      if (!exists) break;\r\n      attempts++;\r\n    } while (attempts < 5);\r\n  }\r\n\r\n  const created = await prisma.link.create({\r\n    data: {\r\n      code: finalCode!,\r\n      url: safeUrl,\r\n    },\r\n  });\r\n\r\n  return created;\r\n}\r\n\r\nexport async function getLinks() {\r\n  return prisma.link.findMany({\r\n    orderBy: { createdAt: 'desc' },\r\n  });\r\n}\r\n\r\nexport async function getLinkByCode(code: string) {\r\n  return prisma.link.findUnique({ where: { code } });\r\n}\r\n\r\nexport async function deleteLink(code: string) {\r\n  // will throw if not found\r\n  return prisma.link.delete({ where: { code } });\r\n}\r\n\r\nexport async function incrementClick(code: string) {\r\n  return prisma.link.update({\r\n    where: { code },\r\n    data: {\r\n      clicks: { increment: 1 },\r\n      lastClicked: new Date(),\r\n    },\r\n  });\r\n}\r\n\r\nexport { prisma };"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAQA,MAAM,SAAS,OAAO,MAAM,IAAI,IAAI,6IAAY;AAChD,wCAA2C,OAAO,MAAM,GAAG;AAE3D,MAAM,aAAa;AAEnB,SAAS,QAAQ,SAAS,CAAC;IACzB,MAAM,QAAQ;IACd,IAAI,IAAI;IACR,IAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,IAAK,KAAK,KAAK,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM,EAAE;IACrF,OAAO;AACT;AAEA,SAAS,eAAe,GAAW;IACjC,IAAI;QACF,kEAAkE;QAClE,MAAM,IAAI,IAAI,IAAI;QAClB,OAAO,EAAE,QAAQ;IACnB,EAAE,OAAM;QACN,MAAM,IAAI,MAAM;IAClB;AACF;AAEO,eAAe,WAAW,EAAE,GAAG,EAAE,IAAI,EAAkC;IAC5E,MAAM,UAAU,eAAe;IAE/B,IAAI,YAAY,MAAM;IACtB,IAAI,WAAW;QACb,IAAI,CAAC,WAAW,IAAI,CAAC,YAAY,MAAM,IAAI,MAAM;QACjD,MAAM,WAAW,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE,MAAM;YAAU;QAAE;QAC3E,IAAI,UAAU,MAAM,IAAI,MAAM;IAChC,OAAO;QACL,yCAAyC;QACzC,IAAI,WAAW;QACf,GAAG;YACD,YAAY,QAAQ;YACpB,MAAM,SAAS,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE,MAAM;gBAAU;YAAE;YACzE,IAAI,CAAC,QAAQ;YACb;QACF,QAAS,WAAW,EAAG;IACzB;IAEA,MAAM,UAAU,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;QACvC,MAAM;YACJ,MAAM;YACN,KAAK;QACP;IACF;IAEA,OAAO;AACT;AAEO,eAAe;IACpB,OAAO,OAAO,IAAI,CAAC,QAAQ,CAAC;QAC1B,SAAS;YAAE,WAAW;QAAO;IAC/B;AACF;AAEO,eAAe,cAAc,IAAY;IAC9C,OAAO,OAAO,IAAI,CAAC,UAAU,CAAC;QAAE,OAAO;YAAE;QAAK;IAAE;AAClD;AAEO,eAAe,WAAW,IAAY;IAC3C,0BAA0B;IAC1B,OAAO,OAAO,IAAI,CAAC,MAAM,CAAC;QAAE,OAAO;YAAE;QAAK;IAAE;AAC9C;AAEO,eAAe,eAAe,IAAY;IAC/C,OAAO,OAAO,IAAI,CAAC,MAAM,CAAC;QACxB,OAAO;YAAE;QAAK;QACd,MAAM;YACJ,QAAQ;gBAAE,WAAW;YAAE;YACvB,aAAa,IAAI;QACnB;IACF;AACF"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/LENOVO/tinylink/TinyLink/app/api/links/%5Bcode%5D/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { getLinkByCode, deleteLink } from \"../../../../lib/db\";\r\n\r\nexport async function GET(request: Request, { params }: { params: any }) {\r\n  const { code } = await params; // <- unwrap Promise\r\n  if (!code) return NextResponse.json({ error: \"Missing code\" }, { status: 400 });\r\n\r\n  const link = await getLinkByCode(code);\r\n  if (!link) return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n\r\n  return NextResponse.json(link);\r\n}\r\n\r\nexport async function DELETE(request: Request, { params }: { params: any }) {\r\n  const { code } = await params; // <- unwrap Promise\r\n  if (!code) return NextResponse.json({ error: \"Missing code\" }, { status: 400 });\r\n\r\n  try {\r\n    const existing = await getLinkByCode(code);\r\n    if (!existing) return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n\r\n    await deleteLink(code);\r\n    return NextResponse.json({ ok: true }, { status: 200 });\r\n  } catch (err) {\r\n    console.error(\"DELETE /api/links/:code error:\", err);\r\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEO,eAAe,IAAI,OAAgB,EAAE,EAAE,MAAM,EAAmB;IACrE,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,oBAAoB;IACnD,IAAI,CAAC,MAAM,OAAO,wKAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IAE7E,MAAM,OAAO,MAAM,IAAA,oJAAa,EAAC;IACjC,IAAI,CAAC,MAAM,OAAO,wKAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAY,GAAG;QAAE,QAAQ;IAAI;IAE1E,OAAO,wKAAY,CAAC,IAAI,CAAC;AAC3B;AAEO,eAAe,OAAO,OAAgB,EAAE,EAAE,MAAM,EAAmB;IACxE,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,QAAQ,oBAAoB;IACnD,IAAI,CAAC,MAAM,OAAO,wKAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IAE7E,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,oJAAa,EAAC;QACrC,IAAI,CAAC,UAAU,OAAO,wKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAE9E,MAAM,IAAA,iJAAU,EAAC;QACjB,OAAO,wKAAY,CAAC,IAAI,CAAC;YAAE,IAAI;QAAK,GAAG;YAAE,QAAQ;QAAI;IACvD,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,wKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}